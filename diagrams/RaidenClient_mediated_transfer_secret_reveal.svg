<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="838px" preserveAspectRatio="none" style="width:885px;height:838px;" version="1.1" viewBox="0 0 885 838" width="885px" zoomAndPan="magnify"><defs><filter height="300%" id="flqh32uinqbv7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="44" x2="44" y1="38.4883" y2="798.4258"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="241" x2="241" y1="38.4883" y2="798.4258"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="438" x2="438" y1="38.4883" y2="798.4258"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="634.5" x2="634.5" y1="38.4883" y2="798.4258"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="791" x2="791" y1="38.4883" y2="798.4258"/><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="8" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="15" y="23.5352">Initiator</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="8" y="797.4258"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="15" y="817.9609">Initiator</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="197" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="204" y="23.5352">Mediator1</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="197" y="797.4258"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="204" y="817.9609">Mediator1</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="394" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="401" y="23.5352">Mediator2</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="394" y="797.4258"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="401" y="817.9609">Mediator2</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="603.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="610.5" y="23.5352">Target</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="603.5" y="797.4258"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="610.5" y="817.9609">Target</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="704" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="156" x="711" y="23.5352">SecretRegistryContract</text><rect fill="#FEFECE" filter="url(#flqh32uinqbv7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="704" y="797.4258"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="156" x="711" y="817.9609">SecretRegistryContract</text><polygon fill="#A80036" points="229,96.4199,239,100.4199,229,104.4199,233,100.4199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44" x2="235" y1="100.4199" y2="100.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="51" y="65.0566">LockedTransfer(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="55" y="80.3672">(HTL, BP, initiator_address,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="55" y="95.6777">target_address)</text><polygon fill="#A80036" points="426,156.3516,436,160.3516,426,164.3516,430,160.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="241" x2="432" y1="160.3516" y2="160.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="248" y="124.9883">LockedTransfer(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="252" y="140.2988">(HTL, BP, initiator_address,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="252" y="155.6094">target_address)</text><polygon fill="#A80036" points="623,216.2832,633,220.2832,623,224.2832,627,220.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="629" y1="220.2832" y2="220.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="445" y="184.9199">LockedTransfer(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="449" y="200.2305">(HTL, BP, initiator_address,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="449" y="215.541">target_address)</text><polygon fill="#A80036" points="55,276.2148,45,280.2148,55,284.2148,51,280.2148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="49" x2="634" y1="280.2148" y2="280.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="61" y="244.8516">SecretRequest(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="65" y="260.1621">(amount, secrethash,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="65" y="275.4727">signature)</text><polygon fill="#A80036" points="623,320.8359,633,324.8359,623,328.8359,627,324.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44" x2="629" y1="324.8359" y2="324.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="51" y="304.7832">RevealSecret(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="55" y="320.0938">(secret, signature)</text><polygon fill="#A80036" points="449,365.457,439,369.457,449,373.457,445,369.457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="443" x2="634" y1="369.457" y2="369.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="455" y="349.4043">RevealSecret(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="459" y="364.7148">(secret, signature)</text><path d="M402,382.457 L402,422.457 L669,422.457 L669,392.457 L659,382.457 L402,382.457 " fill="#FBFB77" filter="url(#flqh32uinqbv7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M659,382.457 L659,392.457 L669,392.457 L659,382.457 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="419.75" y="400.0254">Bad behaviour</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="423.75" y="415.3359">M2 does not send the BP to Target</text><path d="M565,437.0781 L565,477.0781 L701,477.0781 L701,447.0781 L691,437.0781 L565,437.0781 " fill="#FBFB77" filter="url(#flqh32uinqbv7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M691,437.0781 L691,447.0781 L701,447.0781 L691,437.0781 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="571" y="454.6465">waits until lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="575" y="469.957">is about to expire</text><path d="M567,491.6992 L567,546.6992 L699,546.6992 L699,501.6992 L689,491.6992 L567,491.6992 " fill="#FBFB77" filter="url(#flqh32uinqbv7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M689,491.6992 L689,501.6992 L699,501.6992 L689,491.6992 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="573" y="509.2676">CHOICE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="577" y="524.5781">lose the transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="577" y="539.8887">or go ON CHAIN</text><polygon fill="#A80036" points="779,573.9414,789,577.9414,779,581.9414,783,577.9414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="635" x2="785" y1="577.9414" y2="577.9414"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="642" y="573.1992">registerSecret(secret)</text><path d="M165,590.9414 L165,630.9414 L707,630.9414 L707,600.9414 L697,590.9414 L165,590.9414 " fill="#FBFB77" filter="url(#flqh32uinqbv7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M697,590.9414 L697,600.9414 L707,600.9414 L697,590.9414 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="517" x="171" y="608.5098">Secret can be used by all nodes to UNLOCK the transfer after settling the channels</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="175" y="623.8203">SecretRegistry.getSecretRevealBlockHeight(secrethash)</text><polygon fill="#A80036" points="252,673.1836,242,677.1836,252,681.1836,248,677.1836" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="246" x2="437" y1="677.1836" y2="677.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="258" y="657.1309">RevealSecret(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="262" y="672.4414">(secret, signature)</text><polygon fill="#A80036" points="426,702.4941,436,706.4941,426,710.4941,430,706.4941" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="241" x2="432" y1="706.4941" y2="706.4941"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="248" y="701.752">Secret(MSG) BP_M1</text><polygon fill="#A80036" points="55,747.1152,45,751.1152,55,755.1152,51,751.1152" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="49" x2="240" y1="751.1152" y2="751.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="61" y="731.0625">RevealSecret(MSG)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="65" y="746.373">(secret, signature)</text><polygon fill="#A80036" points="229,776.4258,239,780.4258,229,784.4258,233,780.4258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="44" x2="235" y1="780.4258" y2="780.4258"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="51" y="775.6836">Secret(MSG) BP_I</text><!--
@startuml
participant Initiator
participant Mediator1
participant Mediator2
participant Target
participant SecretRegistryContract

Initiator -> Mediator1: LockedTransfer(MSG) \n (HTL, BP, initiator_address,\n target_address)
Mediator1 -> Mediator2: LockedTransfer(MSG) \n (HTL, BP, initiator_address,\n target_address)
Mediator2 -> Target: LockedTransfer(MSG) \n (HTL, BP, initiator_address,\n target_address)
Target -> Initiator: SecretRequest(MSG) \n (amount, secrethash,\n signature)
Initiator -> Target: RevealSecret(MSG) \n (secret, signature)
Target -> Mediator2: RevealSecret(MSG) \n (secret, signature)

Note over Mediator2, Target: Bad behaviour \n M2 does not send the BP to Target


Note over Target: waits until lock \n is about to expire
Note over Target: CHOICE \n lose the transfer \n or go ON CHAIN
Target -> SecretRegistryContract: registerSecret(secret)
Note over Mediator1, Target: Secret can be used by all nodes to UNLOCK the transfer after settling the channels \n SecretRegistry.getSecretRevealBlockHeight(secrethash)
Mediator2 - -> Mediator1: RevealSecret(MSG) \n (secret, signature)
Mediator1 - -> Mediator2: Secret(MSG) BP_M1
Mediator1 - -> Initiator: RevealSecret(MSG) \n (secret, signature)
Initiator - -> Mediator1: Secret(MSG) BP_I
@enduml

PlantUML version 1.2018.08(Sun Jun 24 20:31:00 HKT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_121-b15
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>